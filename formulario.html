<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BEO.</title>
<style>
/* ===== PANTALLA: ESTILO LEGIBLE ===== */
body {
  font-family: "Times New Roman", Times, serif;
  font-size: 10pt;
  color: #000;
  background: #fff;
  margin: 15mm;
}

h2 {
  text-align: center;
  font-size: 11pt;
  color: #fff;
  background-color: #0d3b66;
  padding: 6px 0;
  border-radius: 4px;
  margin: 10px 0;
}

/* Tablas: pantalla */
table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 10px;
  table-layout: fixed;
}

th, td {
  border: 1px solid #0d3b66;
  padding: 6px 8px;
  vertical-align: middle;
  text-align: center;
  font-size: 10pt;
}

th {
  background-color: #0d3b66;
  color: #fff;
  font-weight: bold;
}

td { background-color: #fff; }

/* Contenedor doble */
.tabla-doble {
  display: flex;
  gap: 12px;
  align-items: flex-start;
}

/* Cada tabla ocupa la mitad (ajustable) */
#tablaMantenimiento, #productosServicios {
  width: 49%;
}

/* Fila de firmas - pantalla */
.signature td {
  height: 60px;
  vertical-align: bottom;
  font-weight: bold;
  text-align: center;
  border: 1px solid #0d3b66;
}

/* ===== IMPRESI√ìN: versi√≥n compacta para caber en una sola hoja carta ===== */
@media print {
  * { -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }

  body {
    margin: 8mm 8mm !important;           /* m√°rgenes m√°s peque√±os en impresi√≥n */
    font-family: "Times New Roman", Times, serif !important;
    font-size: 9pt !important;
  }

  h2 { font-size: 10pt !important; padding: 4px 0 !important; margin: 6px 0 !important; }

  table { margin-bottom: 6px !important; table-layout: fixed !important; width: 100% !important; }
  th, td {
    padding: 3px 4px !important;
    font-size: 9pt !important;
    line-height: 1 !important;
  }

  /* Tablas lado a lado */
  .tabla-doble { display: flex !important; gap: 6px !important; }
  #tablaMantenimiento, #productosServicios { width: 49% !important; }

  /* Firmas impresas */
  .signature td { height: 45px !important; }

  /* P√°gina carta (portrait) y margen */
  @page { size: letter portrait; margin: 8mm 8mm; }

  /* Ocultar botones */
  button, .print-btn { display: none !important; }
}
</style>

</head>
<body>

<h2>ORDEN DE TRABAJO (BEO) - RESERVACIONES EVENTOS</h2>

<!-- DATOS GENERALES -->
<h2>DATOS GENERALES</h2>
<table class="beo-section">
  <tr>
    <th>N¬∞ de Reserva</th>
    <th>Sal√≥n</th>
    <th>Tipo de evento</th>
    <th>N¬∞ Personas</th>
  </tr>
  <tr class="data-row">
    <td id="numReserva"></td>
    <td id="salon"></td>
    <td id="tipoEvento"></td>
    <td id="numPersonas"></td>
  </tr>
  <tr>
    <th>Fecha registro</th>
    <th>Fecha evento</th>
    <th>Hora inicio</th>
    <th>Hora fin</th>
  </tr>
  <tr class="data-row">
    <td id="fechaRegistro"></td>
    <td id="fechaEvento"></td>
    <td id="horaInicio"></td>
    <td id="horaFin"></td>
  </tr>
</table>

<!-- DATOS DEL CLIENTE -->
<h2>DATOS DEL CLIENTE</h2>
<table class="beo-section">
  <tr>
    <th>Facturar a nombre de:</th>
    <th>Tel√©fono</th>
    <th>Nombre en cartera</th>
    <th>C√≥digo</th>
  </tr>
  <tr class="data-row">
    <td id="facturarA"></td>
    <td id="telefono"></td>
    <td id="nombreCartera"></td>
    <td id="codigo"></td>
  </tr>
  <tr>
    <th>Contacto comercial</th>
    <th>Contacto en el evento</th>
    <th>Tel. contacto</th>
    <th>Responsable de pago</th>
  </tr>
  <tr class="data-row">
    <td id="contactoComercial"></td>
    <td id="contactoEvento"></td>
    <td id="telContacto"></td>
    <td id="responsablePago"></td>
  </tr>
  <tr>
    <th>DUI</th>
    <th>NIT</th>
    <th>No. IVA</th>
    <th></th>
  </tr>
  <tr class="data-row">
    <td id="dui"></td>
    <td id="nit"></td>
    <td id="iva"></td>
    <td></td>
  </tr>
</table>

<!-- DATOS DEL RESPONSABLE -->
<h2>DATOS DEL RESPONSABLE</h2>
<table class="beo-section">
  <tr>
    <th>Ejecutiva de ventas</th>
    <th>Tel. ejecutiva</th>
    <th>Cel. ejecutiva</th>
  </tr>
  <tr class="data-row">
    <td id="ejecutivaVentas"></td>
    <td id="telEjecutiva"></td>
    <td id="celEjecutiva"></td>
  </tr>
</table>

<!-- MONTAJE Y COCINA -->
<table>
<tr><th colspan="2" class="section-title">MONTAJE</th><th colspan="2" class="section-title">COCINA</th></tr>
<tr><td colspan="2" id="montajeData"></td><td colspan="2" id="cocinaData"></td></tr>
</table>

<!-- OBSERVACIONES -->
<table>
<tr><th class="section-title">Observaciones / Detalles de mantenimiento</th></tr>
<tr><td id="manObservacionesText"></td></tr>
</table>

<div class="tabla-doble">
  <!-- TABLA MANTENIMIENTO -->
<table id="tablaMantenimiento">
  <thead>
    <tr><th colspan="4">MANTENIMIENTO</th></tr>
    <tr>
      <th>N¬∞ ing. Caja</th>
      <th>Fecha</th>
      <th>Valor</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr><td>D</td><td>580</td><td>5/11/2025</td><td>100</td></tr>
    <tr><td>1</td><td>520</td><td>13/11/2025</td><td>120</td></tr>
    <tr><td>2</td><td>120</td><td>19/11/2025</td><td>130</td></tr>
  </tbody>
</table>

  <!-- ===== TABLA PRODUCTOS Y SERVICIOS ===== -->
  <table id="productosServicios">
    <thead>
      <tr>
        <th colspan="5">PRODUCTOS Y SERVICIOS</th>
      </tr>
      <tr>
        <th style="width:12%;">C√≥d.</th>
        <th style="width:48%;">Descripci√≥n</th>
        <th style="width:10%;">Cant.</th>
        <th style="width:15%;">Precio</th>
        <th style="width:15%;">Valor</th>
      </tr>
    </thead>
    <tbody>
      <!-- Filas din√°micas desde BEO -->
    </tbody>
    <tfoot>
      <tr>
        <th colspan="4" style="text-align:right; font-weight:700; padding-right:10px;">
          TOTAL ORDEN
        </th>
        <th id="totalProductos" style="text-align:right; font-weight:700;">$0.00</th>
      </tr>
    </tfoot>
  </table>
</div>

<!-- ===== FIRMAS ===== -->
<table class="signature">
  <tr>
    <td>_________________<br>Gerente</td>
    <td>_________________<br>Ventas</td>
    <td>_________________<br>Cliente</td>
    <td>_________________<br>Cocina</td>
    <td>_________________<br>Mantenimiento</td>
  </tr>
</table>

<div class="print-btn"><button onclick="window.print()">üñ®Ô∏è Imprimir BEO</button></div>

<script>
// Script robusto para llenar BEO sin romper nada
window.addEventListener('DOMContentLoaded', () => {
    const reserva = JSON.parse(localStorage.getItem('datosBEO') || '{}');
    if (!reserva) return;
   
    /* -----------------------
       1) DATOS GENERALES
       - Intentamos por ID (si existen en tu HTML).
       - Si no existen, caemos al mapeo por posici√≥n sobre #tablaEvento td (compatible con versi√≥n anterior).
       -----------------------*/
    const tryFillByIds = () => {
        // mapa id -> key de reserva
        const map = {
            '#reservaId': ['id','reservaId','numeroReserva','numReserva'],
            '#salon': ['salon'],
            '#tipoEvento': ['tipoEvento','tipo'],
            '#numPersonas': ['numPersonas','personas','nPersonas'],
            '#fechaRegistro': ['fechaRegistro','fechaCreacion'],
            '#fechaEvento': ['fechaEvento','fecha'],
            '#horaInicio': ['horaInicio','horaInicioEvento','hora_inicio'],
            '#horaFin': ['horaFin','horaFinEvento','hora_fin'],

            '#facturarA': ['facturarA','facturar','facturaNombre'],
            '#telefono': ['telefono','tel'],
            '#nombreCartera': ['nombreCartera'],
            '#codigo': ['codigo','cod'],

            '#contactoComercial': ['contactoComercial','contactoComercialNombre'],
            '#contactoEvento': ['contactoEvento','contacto_en_evento'],
            '#telContacto': ['telContacto','telefonoContacto'],
            '#responsablePago': ['responsablePago','respPago'],

            '#dui': ['dui'],
            '#nit': ['nit'],
            '#iva': ['iva','noIva','no_iva'],

            '#ejecutivaVentas': ['ejecutivaVentas','ejecutiva'],
            '#telEjecutiva': ['telEjecutiva','telEjecutivaCampo','telefonoEjecutiva'],
            '#celEjecutiva': ['celEjecutiva','celularEjecutiva']
        };

        let filledAny = false;
        Object.entries(map).forEach(([selector, keys]) => {
            const el = document.querySelector(selector);
            if (!el) return;
            for (const k of keys) {
                if (reserva[k] !== undefined && reserva[k] !== null && String(reserva[k]).trim() !== '') {
                    el.textContent = reserva[k];
                    filledAny = true;
                    break;
                }
            }
        });
        return filledAny;
    };

    const filledByIds = tryFillByIds();

    if (!filledByIds) {
        // Fallback: llenar por posici√≥n (como versi√≥n anterior)
        const camposEvento = document.querySelectorAll('#tablaEvento td');
        const ordenKeys = [
            'id','fechaEvento','horaInicio','horaFin','salon','tipoEvento',
            'facturarA','telefono','numPersonas','nombreCartera','codigo',
            'contactoComercial','contactoEvento','telContacto','responsablePago',
            'dui','nit','ejecutivaVentas','telEjecutiva','celEjecutiva'
        ];
        if (camposEvento && camposEvento.length) {
            ordenKeys.forEach((key, idx) => {
                if (reserva[key] !== undefined && reserva[key] !== null && camposEvento[idx]) {
                    camposEvento[idx].textContent = reserva[key];
                }
            });
            // Aseguramos el n√∫mero de reserva si no cuadr√≥ por orden
            if (!document.querySelector('#reservaId')) {
                // intentar ubicar el primer td (si el id no existe)
                if (camposEvento[0] && (reserva.id || reserva.reservaId || reserva.numeroReserva || reserva.numReserva)) {
                    camposEvento[0].textContent = reserva.id || reserva.reservaId || reserva.numeroReserva || reserva.numReserva;
                }
            }
        } else {
            // Si no hay #tablaEvento (por alguna raz√≥n), intentar escribir N¬∞ reserva en cualquier lugar visible
            const firstTitle = document.querySelector('h2');
            if (firstTitle && (reserva.id || reserva.reservaId)) {
                // no sobrescribimos t√≠tulo, solo como √∫ltimo recurso
                console.warn('No se encontr√≥ #tablaEvento; N¬∞ reserva:', reserva.id || reserva.reservaId);
            }
        }
    }

    // Si falta el n√∫mero de reserva visible en pantalla, forzamos colocarlo en el primer td si existe
    const ensureReservaVisible = () => {
        const hasReservaById = document.querySelector('#reservaId') && document.querySelector('#reservaId').textContent.trim() !== '';
        if (!hasReservaById) {
            const firstTd = document.querySelector('#tablaEvento td');
            const val = reserva.id || reserva.reservaId || reserva.numeroReserva || reserva.numReserva;
            if (firstTd && val) firstTd.textContent = val;
        }
    };
    ensureReservaVisible();

    /* -----------------------
       2) MONTAJE / COCINA / OBSERVACIONES
       ----------------------- */
    const montajeEl = document.getElementById('montajeData');
    const cocinaEl = document.getElementById('cocinaData');
    const obsEl = document.getElementById('manObservacionesText');
    if (montajeEl) montajeEl.textContent = (reserva.montaje || []).map(m => `${m.tipo || m.name || m.item || ''}: ${m.cantidad || ''}`).join(', ');
    if (cocinaEl) cocinaEl.textContent = (reserva.cocina || []).map(c => `${c.item || c.name || ''}: ${c.cantidad || ''}`).join(', ');
    if (obsEl) obsEl.textContent = reserva.manObservaciones || '';

    /* -----------------------
       3) TABLA MANTENIMIENTO (compatibilidad total)
       - Si existen filas plantilla en tbody, mantenemos la primera columna tal cual
         y escribimos en children[1..3], que fue el comportamiento original.
       - Si no existen filas plantilla (tbody vac√≠o), creamos filas con 4 celdas.
       ----------------------- */
    (function fillMantenimiento() {
        const tbody = document.querySelector('#tablaMantenimiento tbody');
        if (!tbody) return;

        const data = reserva.mantenimiento || [];
        // Si hay filas existentes en el tbody (plantilla), usamos ese enfoque para no romper el "N¬∞ ing. Caja"
        const existingRows = Array.from(tbody.querySelectorAll('tr'));
        if (existingRows.length >= data.length && existingRows.length > 0) {
            // Limpiamos las celdas que deben ser reemplazadas (children[1..3]) y llenamos seg√∫n data
            data.forEach((m, i) => {
                const row = existingRows[i];
                // aseguramos que tenga al menos 4 celdas
                while (row.children.length < 4) row.insertCell();
                // Rellenar children[1..3] (manteniendo children[0] que probablemente tenga D,1,2)
                row.children[1].textContent = m.dato || m.codigo || m.caja || m.ref || '';
                row.children[2].textContent = m.fecha || m.date || '';
                row.children[3].textContent = (m.valor !== undefined ? m.valor : (m.monto !== undefined ? m.monto : '')) || '';
            });
            // Si hay m√°s filas plantilla de las necesarias, dejamos las restantes en blanco
            for (let j = data.length; j < existingRows.length; j++) {
                const row = existingRows[j];
                while (row.children.length < 4) row.insertCell();
                row.children[1].textContent = '';
                row.children[2].textContent = '';
                row.children[3].textContent = '';
            }
        } else {
            // Caso din√°mico: creamos filas nuevas respetando 4 columnas
            tbody.innerHTML = ''; // limpiamos
            if (data.length === 0) {
                // dejamos 3 filas vac√≠as como plantilla si no hay datos
                for (let r = 0; r < 3; r++) {
                    const tr = tbody.insertRow();
                    tr.insertCell().textContent = ''; // N¬∞ ing. Caja
                    tr.insertCell().textContent = '';
                    tr.insertCell().textContent = '';
                    tr.insertCell().textContent = '';
                }
            } else {
                data.forEach(m => {
                    const tr = tbody.insertRow();
                    // intento inteligente para colocar N¬∞ ing. Caja si viene
                    tr.insertCell().textContent = m.num || m.numCaja || m.numero || m.n || m.dato || '';
                    tr.insertCell().textContent = m.dato || m.codigo || m.caja || m.ref || '';
                    tr.insertCell().textContent = m.fecha || m.date || '';
                    tr.insertCell().textContent = (m.valor !== undefined ? m.valor : (m.monto !== undefined ? m.monto : '')) || '';
                });
            }
        }
    })();

    /* -----------------------
       4) TABLA PRODUCTOS Y SERVICIOS
       (mantener comportamiento previo exacto)
       ----------------------- */
    (function fillProductos() {
        const tbodyProd = document.querySelector('#productosServicios tbody');
        if (!tbodyProd) return;
        tbodyProd.innerHTML = '';
        let total = 0;
        (reserva.productos || []).forEach(p => {
            const tr = tbodyProd.insertRow();
            const codigo = p.codigo || p.cod || p.code || '';
            const descripcion = p.descripcion || p.desc || p.name || '';
            const cantidad = (p.cantidad !== undefined) ? p.cantidad : (p.qty !== undefined ? p.qty : '');
            const precio = (p.precio !== undefined) ? p.precio : (p.price !== undefined ? p.price : '');
            const valorNum = parseFloat(p.valor || (Number(cantidad || 0) * Number(precio || 0))) || 0;

            tr.insertCell().textContent = codigo;
            tr.insertCell().textContent = descripcion;
            tr.insertCell().textContent = cantidad;
            tr.insertCell().textContent = precio;
            const last = tr.insertCell();
            last.textContent = '$' + valorNum.toFixed(2);
            last.style.textAlign = 'right';
            total += valorNum;
        });

        const totalCell = document.getElementById('totalProductos') || document.getElementById('totalOrden');
        if (totalCell) totalCell.textContent = '$' + total.toFixed(2);
    })();

    /* -----------------------
       5) (Opcional) rellenar firmas con nombres desde reserva
       Si quieres descomentar y usar, aseg√∫rate que existan los selectores
       ----------------------- */
    // try {
    //     const firmaVentas = document.querySelector('.firmas div:nth-child(2)');
    //     if (firmaVentas && reserva.ejecutivaVentas) firmaVentas.innerHTML = `_________________<br>${reserva.ejecutivaVentas}`;
    // } catch(e) { /* noop */ }

 // === CORRECCI√ìN FINAL: mostrar N¬∞ de Reserva ===
    const nReserva = reserva.id || reserva.reservaId || reserva.numeroReserva || reserva.numReserva || reserva.Nreserva || reserva.noReserva;
    if (nReserva) {
        const celdaReserva =
            document.getElementById('numReserva') ||
            document.querySelector('#tablaEvento td');

        if (celdaReserva) celdaReserva.textContent = nReserva;
    }
}); // DOMContentLoaded
  

</script>
</body>
</html>

